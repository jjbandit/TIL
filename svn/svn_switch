#! /bin/bash

. ~/til/bash/confirm

. ~/til/svn/svn_wc_base_url.sh

[ $# -eq 0 ] && echo "Please supply a flyspray task number!" && exit 1

svn info > /dev/null 2>&1
[ $? -ne 0 ] && echo "Not a Subversion working copy, exiting." && exit 1

function switchBranch()
{
	# This sets a variable called SvnWcBaseUrl
	GetWcBaseUrl

	if [ $1 = "trunk" ]; then
		svn switch "$SvnWcBaseUrl/trunk" 2> /dev/null
	else
		if [ $1 = "-" ]; then
			svn_switch $(cat ~/.svn_last_branch.tmp)
		else
			svn switch "$SvnWcBaseUrl/branches/FS%20$1"
		fi
	fi
}

### Main

LastBranch=$(svn_current_branch.sh)

switchBranch "$1"

if [ $? -ne 0 ]; then

	echo -n "Couldn't switch to the branch, create it instead?"

	Confirm

	if [ $Confirm -eq 0 ]; then  # We decided to create a new branch
		svn_branch.sh "$1"
	else
		echo "Aborting"
		exit 1
	fi

	if [ $? -ne 0 ]; then  # Branch creation failed
		echo "Branch creation failed, something has gone horribly wrong."
		exit 1
	else  # We created a new branch and are switching to it
		switchBranch "$1"
		echo $LastBranch > ~/.svn_last_branch.tmp
	fi
else  # we sucessfully switched, write the last branch number out
		echo $LastBranch > ~/.svn_last_branch.tmp
fi

# Finally, whatever the result, update the branch we're currently on
svn info | grep "Relative URL" | rev | cut -c -5 | rev > ./.current_branch
